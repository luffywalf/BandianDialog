<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>{{title}}</title>

    <link rel="stylesheet" href="/static/bootstrap.min.css">
    <link rel="stylesheet" href="/static/chat.css">

    <!--[if lt IE 9]>
      <script src="/static/html5shiv.min.js"></script>
      <script src="/static/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<div class="chat_window">
    <div class="top_menu">
        <div class="title">{{title}}
            {% if show_log %}
                <a href="#" id="show_log">查看日志</a>
            {% end %}
        </div>
    </div>
    <ul class="messages">
    </ul>
    <div class="bottom_wrapper clearfix">
        <div class="message_input_wrapper">
            <input class="message_input" placeholder=""/>
        </div>
        <div class="send_message">
            <div class="text" id="sendbtn">发送</div>
        </div>
    </div>
</div>
<script src="/static/jquery.min.js"></script>
<script src="/static/bootstrap.min.js"></script>
<script type="application/javascript">
    $(document).ready(function() {
        var S4 = function() {
           return (((1+Math.random())*0x10000)|0).toString(16).substring(1);
        };
        uid = (S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4());
        var ws = new WebSocket("ws://" + window.location.host + '/ws/' + uid)

        show_log_flag = false;
        $("#show_log").click(function () {
            if (show_log_flag) {
                window.open("http://"+ window.location.host + "/log/" + uid + ".txt")
            } else {
                window.alert("多聊几句！")
            }
        })

        function add_item(cl, msg) {
            if (cl === 'right') {
                role = '用户'
            } else {
                role = '客服'
            }
            var template_html = '<li class="message '+ cl + ' appeared"><div class="avatar"><div class="text"><b>'+ role + '</b></div></div><div class="text_wrapper"><div class="text">' + msg + '</div></div></li>';
            $('.messages').append(template_html);
            $('.messages').animate({scrollTop: $('.messages').prop("scrollHeight")}, 500);
        }

        ws.onmessage = function(evt) {
            show_log_flag = true;
            add_item('left', evt.data);
        }

        function send_msg() {
            msg = $('.message_input').val()
            if (msg.length === 0) {
                console.log("不能发送空数据！")
                return;
            }
            add_item('right', msg)
            $(".message_input").val("")
            ws.send(msg);
        }
        $('.send_message').click(send_msg)
        $('.message_input').keypress(function(e) {
            if(e.which == 13) {
                send_msg()
            }
        })
    });
</script>
</body>
</html>
